  function init(url, torrent)
  {
    alert('url='+url+'   torrent='+torrent);
    var conn = new SockJS('http://localhost:6868/websocket');
    var err = true;

    function sendRequest()
    {
      err = false;
      conn.send('VERSION');
    };

    conn.onopen = function() 
    {
      alert('onopen');
      sendRequest();
    };

    conn.onmessage = function(e) 
    {
      chk_version(e.data);
      window.location.href = 'http://localhost:6878/get_video?url='+url+'&torrent='+torrent;
    };

    conn.onclose = function() {
      alert('onclose');
      if(err == true)
      {
        alert('Error !!!');
	error();
      }

    };


    conn.onerror = function() {
      alert('Error !!!');
    };
  }

  function error()
  {
    var parent = document.getElementsByTagName('BODY')[0];
    var par = document.createElement('parent_popup');
    par.id = 'parent_popup';
    var pop = document.createElement('popup');
    pop.id = 'popup';
    var par_r = parent.appendChild(par);
    var pop_r = par_r.appendChild(pop);

    pop_r.innerHTML = '<input type=\"button\" name=\"install\" value=\" Install \" onclick=\"install()\;\">';
    pop_r.innerHTML = pop_r.innerHTML + '<input type=\"button\" name=\"continue\" value=\" Continue \" onclick=\"next()\;\">';
    pop_r.innerHTML = pop_r.innerHTML + ' <p>Text in window.</p>';

  }

  function install() {
     alert('Button1');
     document.getElementById('parent_popup').style.display='none';
  }

  function next() {
//     var torrent = {{ str.torrent }};
//     alert(torrent);
     var sss = get_seeders('Volk');
     var ip = sss.split(",");
     alert('ip='+ip[0]);
     document.getElementById('parent_popup').style.display='none';
     document.getElementById('content').innerHTML = '';
  }


  function getXmlHttp(){
    var xmlhttp;
    try {
      xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
    } catch (e) {
      try {
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
      } catch (E) {
        xmlhttp = false;
      }
    }
    if (!xmlhttp && typeof XMLHttpRequest!='undefined') {
      xmlhttp = new XMLHttpRequest();
    }
    return xmlhttp;
  }

  function chk_version(swarm_version) {
      var req = getXmlHttp();
      req.onreadystatechange = function() { 
          if (req.readyState == 4) {
              if(req.status == 200) {
		  if(parseFloat(swarm_version) < parseFloat(req.responseText) )
		  {
		    error();
		  }
		  //alert('swarm_version=' + swarm_version);
		  //alert('Am server = ' + req.responseText);

              }
          }
      }
      req.open('GET', '/version', true); 
      req.send(null);
  }

  function get_seeders(torrent) {
      var req = getXmlHttp();
      var str = '/seeders/'+torrent;
      req.open('GET', str, false);
      req.send(null);
      if(req.status == 200) {
          return req.responseText;
      }
  }


    function refresh(text) {
	document.getElementById('output').innerHTML = text;
    }

    function supports_video() {
      return !!document.createElement('video').canPlayType;
    }

    function supports_webm_video() {
      if (!supports_video()) { return false; }
      var v = document.createElement("video");
      return v.canPlayType('video/webm; codecs="vp8, vorbis"');
    }

////  Video player //////////////////////////////////////////////

    _V_("video").ready(function()
    {
          var first = true;
          var myPlayer = this;
          var hide_play_message = false;
	  var time = 0;
	  myPlayer.addEvent("play", function()
  	  {
	    if(first == true)
	    {
	      first = false;
	      //myPlayer.src({ type: "video/webm", src: "http://localhost:6878/get_http_video?file=KKK.webm" });
	      myPlayer.src({ type: "video/webm", src: "http://95.86.233.199:6878/KKK.webm" });
              myPlayer.play();
          }
	    else
	    {
	      if(hide_play_message == false) refresh('Playing ...');
	    }
	  });

	  myPlayer.addEvent("loadstart", function()
	  {
	    hide_play_message = true;
            refresh('Prepare to start ...');
	  });

	  myPlayer.addEvent("loadeddata", function()
	  {
	    hide_play_message = false;
	    refresh('Playing ...');
	    myPlayer.pause();
	    myPlayer.currentTime(180);
	    myPlayer.play();
	  });

	  myPlayer.addEvent("pause", function()
	  {
	    refresh('Pause ...');
	  });

	  myPlayer.addEvent("ended", function()
	  {
	    refresh('Ended !!!');
	  });

	  myPlayer.addEvent("error", function()
	  {
	    refresh('Error !!!');
	    myPlayer.src({ type: "video/webm", src: "http://107.22.233.233:6878/KKK.webm" });
	    myPlayer.currentTime(time);

            myPlayer.play();

	  });

	  myPlayer.addEvent("timeupdate", function()
	  {
	    time = myPlayer.currentTime();
	  });

    });

